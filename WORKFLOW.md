# ğŸ“Š Rabbit AI Avatar - è©³ç´°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€Rabbit AI Avatarã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ç›®æ¬¡

- [å…¨ä½“ãƒ•ãƒ­ãƒ¼å›³](#å…¨ä½“ãƒ•ãƒ­ãƒ¼å›³)
- [ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³](#ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³)
- [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³)
- [ä¸¦åˆ—TTSå‡¦ç†](#ä¸¦åˆ—ttså‡¦ç†)
- [æ„Ÿæƒ…ãƒ•ãƒ­ãƒ¼](#æ„Ÿæƒ…ãƒ•ãƒ­ãƒ¼)
- [æ˜ ç”»æ¤œç´¢Tool Useãƒ•ãƒ­ãƒ¼](#æ˜ ç”»æ¤œç´¢tool-useãƒ•ãƒ­ãƒ¼)
- [Lottieã‚¢ãƒã‚¿ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ](#lottieã‚¢ãƒã‚¿ãƒ¼ã‚·ã‚¹ãƒ†ãƒ )

---

## å…¨ä½“ãƒ•ãƒ­ãƒ¼å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                  USER INTERACTION                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  User types: "ãŠã™ã™ã‚ã®ã‚¢ãƒ‹ãƒ¡æ˜ ç”»ã‚’æ•™ãˆã¦"                                   â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  ChatInput Component â†’ WebSocket.send({ type: "text_input", text: "..." }) â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Frontend: Start TTFR timer (requestStartTimeRef)                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: WebSocketé€šä¿¡ (Frontend â†’ Backend)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Message: { "type": "text_input", "text": "ãŠã™ã™ã‚ã®ã‚¢ãƒ‹ãƒ¡æ˜ ç”»ã‚’æ•™ãˆã¦" }    â”‚  â”‚
â”‚  â”‚  Protocol: ws://localhost:3001/ws                                           â”‚  â”‚
â”‚  â”‚  Connection: Persistent WebSocket                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: Backendå‡¦ç†é–‹å§‹                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  WebSocket Handler receives message                                         â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Request deduplication check (pendingRequest flag)                          â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Start WorkflowTimer (performance tracking)                                 â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Send status: { type: "status", status: "thinking", emotion: "thinking" }  â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Frontend: Avatar switches to thinking.lottie animation                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: Claude APIå‘¼ã³å‡ºã— + ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚° (â±ï¸ ~500-2000ms)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Model: claude-3-5-haiku-20241022 (streaming enabled)                       â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  System Prompt: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š + æ„Ÿæƒ…ã‚¿ã‚°æŒ‡ç¤º                               â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  User Message: "ãŠã™ã™ã‚ã®ã‚¢ãƒ‹ãƒ¡æ˜ ç”»ã‚’æ•™ãˆã¦"                                 â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Tool Available: search_movies (æ˜ ç”»æ¤œç´¢)                                    â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  [STREAMING] ãƒ†ã‚­ã‚¹ãƒˆdeltaã‚’é€æ¬¡é€ä¿¡ â†’ assistant_delta messages             â”‚  â”‚
â”‚  â”‚  [PARALLEL]  å®Œæˆã—ãŸæ–‡ã‚’å³åº§ã«TTSã‚­ãƒ¥ãƒ¼ã«è¿½åŠ                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Prefetch Optimization â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚                                                                       â”‚        â”‚
â”‚  â”‚   needsMovieSearch() â†’ æ˜ ç”»é–¢é€£ã‚¯ã‚¨ãƒªã‚’äº‹å‰æ¤œå‡º                       â”‚        â”‚
â”‚  â”‚   â†“                                                                   â”‚        â”‚
â”‚  â”‚   DBæ¤œç´¢ã‚’ä¸¦åˆ—ã§é–‹å§‹ (prefetchPromise)                                â”‚        â”‚
â”‚  â”‚   â†“                                                                   â”‚        â”‚
â”‚  â”‚   Claude ãŒtool_useã‚’è¿”ã—ãŸã‚‰å³åº§ã«çµæœã‚’ä½¿ç”¨                         â”‚        â”‚
â”‚  â”‚                                                                       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4.5: Two-Tier Waiting System (Short + Long)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [TWO-TIER INTELLIGENT WAITING SYSTEM]                                      â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  TIER 1: SHORT WAITING (> 1s) - Quick Acknowledgment                       â”‚  â”‚
â”‚  â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚  â”‚
â”‚  â”‚  Purpose: Brief feedback when response takes longer than expected          â”‚  â”‚
â”‚  â”‚  Trigger: Backend does NOT respond within NEXT_PUBLIC_WAITING_THRESHOLD    â”‚  â”‚
â”‚  â”‚           (threshold exceeded, > 1s)                                        â”‚  â”‚
â”‚  â”‚  Audio: /waiting-short/0-9.mp3 (10 sounds)                                 â”‚  â”‚
â”‚  â”‚  Examples: "ã‚ã‚" (ah), "ã†ã‚“" (un), "ãˆã£ã¨" (etto), "ãªã‚‹ã»ã©"          â”‚  â”‚
â”‚  â”‚  Duration: < 1 second each                                                  â”‚  â”‚
â”‚  â”‚  Behavior: Protected playback, must complete before backend audio          â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  TIER 2: LONG WAITING - Server-Side Context-Aware Confirmation             â”‚  â”‚
â”‚  â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚  â”‚
â”‚  â”‚  SERVER-SIDE - Database Query Confirmation (NEW!)                          â”‚  â”‚
â”‚  â”‚     Trigger: Tool use detected (database search)                            â”‚  â”‚
â”‚  â”‚     Generation: Real-time TTS with context                                  â”‚  â”‚
â”‚  â”‚     Examples:                                                               â”‚  â”‚
â”‚  â”‚       - "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ˜ ç”»ã§ã™ã­ã€ä»Šæ¢ã—ã¦ã„ã¾ã™ã®ã§å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚"    â”‚  â”‚
â”‚  â”‚       - "2020å¹´ã®ä½œå“ã§ã™ã­ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚"              â”‚  â”‚
â”‚  â”‚       - "å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€ä»Šã™ãæ¢ã—ã¦ã¿ã¾ã™ã­ã€‚"                       â”‚  â”‚
â”‚  â”‚     Features:                                                               â”‚  â”‚
â”‚  â”‚       âœ“ Confirms user's request (query, genre, year)                       â”‚  â”‚
â”‚  â”‚       âœ“ Streams immediately when tool use starts                           â”‚  â”‚
â”‚  â”‚       âœ“ Gives progress feedback during slow operations                     â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  [FLOW DIAGRAM]                                                             â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  1. User submits message â†’ Backend starts processing                       â”‚  â”‚
â”‚  â”‚     â†“                                                                       â”‚  â”‚
â”‚  â”‚  2. Frontend starts 1s timer                                                â”‚  â”‚
â”‚  â”‚     â†“                                                                       â”‚  â”‚
â”‚  â”‚  3. Decision Tree:                                                          â”‚  â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚
â”‚  â”‚     â”‚ IF backend responds within 1s (fast):                         â”‚      â”‚  â”‚
â”‚  â”‚     â”‚   â†’ NO waiting sound                                           â”‚      â”‚  â”‚
â”‚  â”‚     â”‚   â†’ Play backend response immediately                          â”‚      â”‚  â”‚
â”‚  â”‚     â”‚                                                                â”‚      â”‚  â”‚
â”‚  â”‚     â”‚ IF backend responds after 1s (slow) WITHOUT tool use:         â”‚      â”‚  â”‚
â”‚  â”‚     â”‚   â†’ Play SHORT waiting sound: "ã‚ã‚", "ã†ã‚“", "ãˆã£ã¨"        â”‚      â”‚  â”‚
â”‚  â”‚     â”‚   â†’ Protected playback (must complete)                         â”‚      â”‚  â”‚
â”‚  â”‚     â”‚   â†’ After completion + 500ms delay                             â”‚      â”‚  â”‚
â”‚  â”‚     â”‚   â†’ Play backend response                                      â”‚      â”‚  â”‚
â”‚  â”‚     â”‚                                                                â”‚      â”‚  â”‚
â”‚  â”‚     â”‚ IF backend uses database tool (any time):                     â”‚      â”‚  â”‚
â”‚  â”‚     â”‚   â†’ Backend sends LONG waiting with context immediately       â”‚      â”‚  â”‚
â”‚  â”‚     â”‚      Example: "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ˜ ç”»ã§ã™ã­ã€ä»Šæ¢ã—ã¦ã„ã¾ã™ã€‚"        â”‚      â”‚  â”‚
â”‚  â”‚     â”‚   â†’ Cancels client-side short waiting if not yet triggered    â”‚      â”‚  â”‚
â”‚  â”‚     â”‚   â†’ Plays confirmation + performs database search             â”‚      â”‚  â”‚
â”‚  â”‚     â”‚   â†’ Sends final search results                                â”‚      â”‚  â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  [CONFIGURATION - Environment Variables]                                    â”‚  â”‚
â”‚  â”‚  - NEXT_PUBLIC_WAITING_THRESHOLD: Time before playing waiting phrase (1s)  â”‚  â”‚
â”‚  â”‚  - NEXT_PUBLIC_POST_WAITING_DELAY: Delay after waiting phrase (0.5s)       â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  [FEATURES]                                                                 â”‚  â”‚
â”‚  â”‚  âœ“ 10 short waiting sounds (for slow responses > 1s)                       â”‚  â”‚
â”‚  â”‚  âœ“ Fast responses (< 1s) play immediately with no waiting                  â”‚  â”‚
â”‚  â”‚  âœ“ Server-side context-aware waiting (database operations)                 â”‚  â”‚
â”‚  â”‚  âœ“ Confirms user's search query in natural language                        â”‚  â”‚
â”‚  â”‚  âœ“ Protected short sounds ensure smooth transitions                        â”‚  â”‚
â”‚  â”‚  âœ“ Post-waiting delay (500ms) prevents audio overlap                       â”‚  â”‚
â”‚  â”‚  âœ“ Intelligent timing based on response speed                              â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  [TIMING DIAGRAMS]                                                          â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  Scenario A: Fast Response (< 1s) - NO Waiting Sound                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚  â”‚  0ms         800ms                                            â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  â”‚           â”‚                                                â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  â”‚           â”‚                                                â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  Submit      Response Arrives                                â”‚          â”‚  â”‚
â”‚  â”‚  â”‚              â†’ Play immediately (NO waiting sound)           â”‚          â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  Scenario B: Database Query - Server LONG Waiting                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚  â”‚  0ms     200ms          2500ms         4000ms                â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  â”‚       â”‚              â”‚              â”‚                      â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  â—â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  â”‚       â”‚              â”‚              â”‚                      â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  Submit  Tool Detected  DB Search      Final Response        â”‚          â”‚  â”‚
â”‚  â”‚  â”‚          â†’ Send: "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ˜ ç”»ã§ã™ã­ã€ä»Šæ¢ã—ã¦ã„ã¾ã™ã€‚"   â”‚          â”‚  â”‚
â”‚  â”‚  â”‚          (Long waiting with context)                         â”‚          â”‚  â”‚
â”‚  â”‚  â”‚                         (Searching...)                       â”‚          â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  Scenario C: Slow Response (> 1s) - SHORT Waiting Sound                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚  â”‚  0ms         1000ms  1800ms  2300ms       3000ms             â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  â”‚           â”‚      â”‚       â”‚            â”‚                   â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  â”‚           â”‚      â”‚       â”‚            â”‚                   â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  Submit      Threshold Short Phrase      Backend             â”‚          â”‚  â”‚
â”‚  â”‚  â”‚              Play   Ends   +500ms        Response            â”‚          â”‚  â”‚
â”‚  â”‚  â”‚              Short  (Protected)          Plays               â”‚          â”‚  â”‚
â”‚  â”‚  â”‚              "ã‚ã‚"                                          â”‚          â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 5: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢ (â±ï¸ ~10-50ms) [Tool Useæ™‚ã®ã¿]                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Query: SELECT * FROM movies WHERE genre @> '{ã‚¢ãƒ‹ãƒ¡}' ORDER BY rating     â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Results: [{ title_ja: "åƒã¨åƒå°‹ã®ç¥éš ã—", rating: 8.6, ... }, ...]        â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Return to Claude as tool_result                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 6: Claudeæœ€çµ‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Claude processes tool_result and generates response                        â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Response Format (with streaming):                                          â”‚  â”‚
â”‚  â”‚  "[EMOTION:excited]                                                         â”‚  â”‚
â”‚  â”‚   ã‚¢ãƒ‹ãƒ¡æ˜ ç”»ã§ã™ã­ï¼ãŠã™ã™ã‚ã‚’ã„ãã¤ã‹ç´¹ä»‹ã—ã¾ã™ã­ï¼                          â”‚  â”‚
â”‚  â”‚   1. åƒã¨åƒå°‹ã®ç¥éš ã— - å®®å´é§¿ç›£ç£ã®åä½œã§ã™..."                             â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Parse: { emotion: "excited", text: "ã‚¢ãƒ‹ãƒ¡æ˜ ç”»ã§ã™ã­ï¼..." }               â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  onSentenceComplete callback â†’ TTS queue per sentence                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 7: ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹é€ä¿¡ (ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [STREAMING] assistant_delta messages sent during LLM processing            â”‚  â”‚
â”‚  â”‚  WebSocket.send({                                                           â”‚  â”‚
â”‚  â”‚    type: "assistant_delta",                                                 â”‚  â”‚
â”‚  â”‚    text: "ã‚¢ãƒ‹ãƒ¡",                                                          â”‚  â”‚
â”‚  â”‚    messageId: "assistant-xxx-123"                                           â”‚  â”‚
â”‚  â”‚  })                                                                         â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  [FINAL] assistant_message with full text                                   â”‚  â”‚
â”‚  â”‚  WebSocket.send({                                                           â”‚  â”‚
â”‚  â”‚    type: "assistant_message",                                               â”‚  â”‚
â”‚  â”‚    text: "ã‚¢ãƒ‹ãƒ¡æ˜ ç”»ã§ã™ã­ï¼ãŠã™ã™ã‚ã‚’ã„ãã¤ã‹ç´¹ä»‹ã—ã¾ã™ã­ï¼...",            â”‚  â”‚
â”‚  â”‚    emotion: "excited",                                                      â”‚  â”‚
â”‚  â”‚    messageId: "assistant-xxx-123"                                           â”‚  â”‚
â”‚  â”‚  })                                                                         â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Frontend: ChatHistory updates + Avatar emotion update                      â”‚  â”‚
â”‚  â”‚  Frontend: Record TTFR (Time to First Response)                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 8: Azure TTSä¸¦åˆ—éŸ³å£°åˆæˆ (â±ï¸ ~200-600ms per chunk)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [PARALLEL TTS - TEN Framework Inspired]                                    â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  Voice: ja-JP-NanamiNeural (female)                                         â”‚  â”‚
â”‚  â”‚  Concurrency Limit: MAX_CONCURRENT_TTS = 3                                  â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚  â”‚
â”‚  â”‚  â”‚ Sentence 1  â”‚  â”‚ Sentence 2  â”‚  â”‚ Sentence 3  â”‚  ...                    â”‚  â”‚
â”‚  â”‚  â”‚ "ã‚¢ãƒ‹ãƒ¡..." â”‚  â”‚ "1. åƒã¨..." â”‚  â”‚ "2. ã‚‚ã®..." â”‚                        â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                         â”‚  â”‚
â”‚  â”‚         â”‚                â”‚                â”‚                                 â”‚  â”‚
â”‚  â”‚         â–¼                â–¼                â–¼                                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚  â”‚
â”‚  â”‚  â”‚  Azure TTS  â”‚  â”‚  Azure TTS  â”‚  â”‚  Azure TTS  â”‚  (parallel)             â”‚  â”‚
â”‚  â”‚  â”‚  ~300ms     â”‚  â”‚  ~400ms     â”‚  â”‚  ~350ms     â”‚                         â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                         â”‚  â”‚
â”‚  â”‚         â”‚                â”‚                â”‚                                 â”‚  â”‚
â”‚  â”‚         â–¼                â–¼                â–¼                                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚  â”‚
â”‚  â”‚  â”‚ audio_chunk â”‚  â”‚ audio_chunk â”‚  â”‚ audio_chunk â”‚                         â”‚  â”‚
â”‚  â”‚  â”‚ index: 0    â”‚  â”‚ index: 1    â”‚  â”‚ index: 2    â”‚                         â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  Short response optimization: Skip chunking for < 30 chars                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 9: éŸ³å£°ãƒ‡ãƒ¼ã‚¿é€ä¿¡ (ãƒãƒ£ãƒ³ã‚¯æ–¹å¼)                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [CHUNK MODE - Parallel TTS]                                                â”‚  â”‚
â”‚  â”‚  WebSocket.send({                                                           â”‚  â”‚
â”‚  â”‚    type: "audio_chunk",                                                     â”‚  â”‚
â”‚  â”‚    data: "base64EncodedChunk...",                                           â”‚  â”‚
â”‚  â”‚    format: "mp3",                                                           â”‚  â”‚
â”‚  â”‚    index: 0,                                                                â”‚  â”‚
â”‚  â”‚    total: 5,                                                                â”‚  â”‚
â”‚  â”‚    isLast: false                                                            â”‚  â”‚
â”‚  â”‚  })                                                                         â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Chunks sent immediately as each TTS completes (not waiting for order)      â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Frontend: Record TTFA (Time to First Audio)                                â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  [FALLBACK MODE - Sequential TTS]                                           â”‚  â”‚
â”‚  â”‚  WebSocket.send({                                                           â”‚  â”‚
â”‚  â”‚    type: "audio",                                                           â”‚  â”‚
â”‚  â”‚    data: "base64EncodedFullAudio...",                                       â”‚  â”‚
â”‚  â”‚    format: "mp3"                                                            â”‚  â”‚
â”‚  â”‚  })                                                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 10: FrontendéŸ³å£°å†ç”Ÿ                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  useAudioPlayer hook receives audio data                                    â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  [CHUNK MODE]                                                               â”‚  â”‚
â”‚  â”‚  - audioQueueRef stores chunks by index                                     â”‚  â”‚
â”‚  â”‚  - playChunk() starts playback when chunk 0 arrives                        â”‚  â”‚
â”‚  â”‚  - processNextChunk() plays sequentially (0 â†’ 1 â†’ 2 â†’ ...)                 â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  [STATUS OVERRIDE - Frontend]                                               â”‚  â”‚
â”‚  â”‚  - audioPlayer.isPlaying â†’ status = "speaking"                             â”‚  â”‚
â”‚  â”‚  - Avatar switches to talk.lottie animation                                 â”‚  â”‚
â”‚  â”‚  - Overrides backend status until audio playback completes                  â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  audio.onended â†’ processNextChunk() or setIsPlaying(false)                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 11: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¿ã‚¤ãƒŸãƒ³ã‚°é€ä¿¡                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  WebSocket.send({                                                           â”‚  â”‚
â”‚  â”‚    type: "workflow_timing",                                                 â”‚  â”‚
â”‚  â”‚    steps: [                                                                 â”‚  â”‚
â”‚  â”‚      { step: "STEP2_WEBSOCKET_SEND", nameJa: "WebSocketé€ä¿¡", durationMs },â”‚  â”‚
â”‚  â”‚      { step: "STEP3_BACKEND_START", nameJa: "Backendå‡¦ç†é–‹å§‹", durationMs },â”‚  â”‚
â”‚  â”‚      { step: "STEP4_LLM_REQUEST", nameJa: "Claude APIå‘¼ã³å‡ºã—", durationMs },â”‚  â”‚
â”‚  â”‚      { step: "STEP7_TEXT_RESPONSE", nameJa: "ãƒ†ã‚­ã‚¹ãƒˆå¿œç­”é€ä¿¡", durationMs },â”‚  â”‚
â”‚  â”‚      { step: "STEP8_TTS_SYNTHESIS", nameJa: "Azure TTSéŸ³å£°åˆæˆ", durationMs },â”‚  â”‚
â”‚  â”‚      { step: "STEP9_AUDIO_SEND", nameJa: "éŸ³å£°ãƒ‡ãƒ¼ã‚¿é€ä¿¡", durationMs },    â”‚  â”‚
â”‚  â”‚    ],                                                                       â”‚  â”‚
â”‚  â”‚    hasDbSearch: true,                                                       â”‚  â”‚
â”‚  â”‚    dbSearchTime: 25,                                                        â”‚  â”‚
â”‚  â”‚    usedTool: true,                                                          â”‚  â”‚
â”‚  â”‚    totalMs: 2150                                                            â”‚  â”‚
â”‚  â”‚  })                                                                         â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Frontend: Calculate TTFR/TTFA from local timestamps                        â”‚  â”‚
â”‚  â”‚  WorkflowTimingDisplay shows performance breakdown                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 12: å®Œäº†ãƒ»å¾…æ©ŸçŠ¶æ…‹ã¸                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Backend sends: { type: "status", status: "idle", emotion: "excited" }     â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  [FRONTEND OVERRIDE]                                                        â”‚  â”‚
â”‚  â”‚  - If audioPlayer.isPlaying === true â†’ status stays "speaking"             â”‚  â”‚
â”‚  â”‚  - Avatar continues talk.lottie until audio finishes                        â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Audio playback completes â†’ status = "idle"                                 â”‚  â”‚
â”‚  â”‚  Avatar switches to idle.lottie                                             â”‚  â”‚
â”‚  â”‚  â†“                                                                          â”‚  â”‚
â”‚  â”‚  Ready for next user input                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User  â”‚     â”‚ Frontend â”‚     â”‚  WebSocket â”‚     â”‚ Backend â”‚     â”‚  Claude â”‚     â”‚ Azure  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚ Type message  â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚ text_input       â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚ + start TTFR     â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚ Forward message â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚ status:thinking  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚  Lottie:      â”‚                  â”‚                 â”‚ Prefetch DB   â”‚               â”‚
    â”‚  thinking     â”‚                  â”‚                 â”‚â”€â” (parallel)  â”‚               â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                 â”‚ â”‚             â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚<â”˜             â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚ Chat stream   â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚ assistant_delta  â”‚                 â”‚  text deltas  â”‚               â”‚
    â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚  TTFR!        â”‚                  â”‚                 â”‚  tool_use:    â”‚               â”‚
    â”‚  Show text    â”‚                  â”‚                 â”‚  search_moviesâ”‚               â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚ tool_result   â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚ sentence done â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚   TTS chunk 0 â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚ Final responseâ”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚ assistant_messageâ”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚ audio_chunk #0   â”‚                 â”‚               â”‚  Audio ready  â”‚
    â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚  TTFA!        â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚  Start play   â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚  Lottie:      â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚  talk         â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚ audio_chunk #1,2 â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚ workflow_timing  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚  Show timing  â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚  â±ï¸ TTFR/TTFA â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚ status:idle      â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚  (still plays â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚   audio...)   â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚  Audio ends   â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚  Lottie: idle â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                 â”‚               â”‚               â”‚
    â”‚               â”‚                  â”‚                 â”‚               â”‚               â”‚
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

```
æ™‚é–“ (ms)    0        500       1000      1500      2000      2500
             â”‚         â”‚         â”‚         â”‚         â”‚         â”‚
             â–¼         â–¼         â–¼         â–¼         â–¼         â–¼
User Input   â—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
             â”‚
             â”œâ”€ WebSocketé€ä¿¡ (~5ms)
             â”‚
LLMå‡¦ç†      â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
(Streaming)  â”‚ â””â”€â”€ Claude API (500-2000ms)
             â”‚     â”‚
             â”‚     â”œâ”€ Text deltas â†’ assistant_delta (TTFR measured here!)
             â”‚     â”‚
             â”‚     â”œâ”€ Tool Useæ¤œå‡º (if needed)
             â”‚     â”‚
DBæ¤œç´¢       â”‚     â”‚â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
(Prefetched) â”‚     â”‚â””â”€â”€ PostgreSQL Query (10-50ms) [parallel with LLM]
             â”‚     â”‚
             â”‚     â”œâ”€ Sentence complete â†’ TTS queue
             â”‚     â”‚
TTSå‡¦ç†      â”‚     â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
(Parallel)   â”‚     â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
             â”‚     â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
             â”‚     â”‚â””â”€â”€ Azure Neural TTS x3 parallel (200-600ms each)
             â”‚                     â”‚
ãƒ†ã‚­ã‚¹ãƒˆå¿œç­”  â”‚                     â—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
             â”‚                     â”‚
éŸ³å£°é€ä¿¡     â”‚                     â”‚â–ˆâ–ˆâ–ˆâ–ˆ audio_chunk #0 (TTFA!)
             â”‚                           â–ˆâ–ˆâ–ˆâ–ˆ audio_chunk #1
             â”‚                               â–ˆâ–ˆâ–ˆâ–ˆ audio_chunk #2
             â”‚                                       â”‚
éŸ³å£°å†ç”Ÿ     â”‚                                       â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
             â”‚                                       â”‚â””â”€â”€ Queued Audio Playback
             â”‚                                                   â”‚
å®Œäº†         â”‚                                                   â—
             â”‚
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Total: ~1.5-3.0s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
             â”‚
             â”‚<â”€â”€â”€ TTFR: ~300-800ms â”€â”€â”€>â”‚
             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€ TTFA: ~800-1500ms â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™

| å‡¦ç† | æœ€å° | å¹³å‡ | æœ€å¤§ | å‚™è€ƒ |
|------|------|------|------|------|
| WebSocketé€ä¿¡ | 1ms | 5ms | 20ms | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¾å­˜ |
| LLM (Claude) | 500ms | 1000ms | 2000ms | å…¥åŠ›é•·ãƒ»Tool Useæœ‰ç„¡ã§å¤‰å‹• |
| DBæ¤œç´¢ | 5ms | 20ms | 100ms | Prefetchæ™‚ã¯LLMã¨ä¸¦åˆ— |
| TTS (Azure) | 200ms | 400ms | 600ms | æ–‡å˜ä½ã§ä¸¦åˆ—å‡¦ç† |
| **TTFR** | **300ms** | **600ms** | **1000ms** | ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§é«˜é€ŸåŒ– |
| **TTFA** | **700ms** | **1200ms** | **2000ms** | ä¸¦åˆ—TTSã§é«˜é€ŸåŒ– |
| **åˆè¨ˆ** | **1000ms** | **2000ms** | **3500ms** | |

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

1. **LLMã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°**: ãƒ†ã‚­ã‚¹ãƒˆdeltaã‚’é€æ¬¡é€ä¿¡ â†’ TTFRå¤§å¹…çŸ­ç¸®
2. **DB Prefetch**: æ˜ ç”»é–¢é€£ã‚¯ã‚¨ãƒªã‚’äº‹å‰æ¤œå‡ºã€LLMã¨ä¸¦åˆ—å®Ÿè¡Œ
3. **ä¸¦åˆ—TTS (TEN Framework)**: æ–‡å˜ä½ã§åŒæ™‚åˆæˆã€MAX_CONCURRENT_TTS=3
4. **ãƒãƒ£ãƒ³ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°**: å®Œæˆã—ãŸéŸ³å£°ã‚’å³é€ä¿¡ï¼ˆé †åºå¾…ã¡ãªã—ï¼‰
5. **Frontend Status Override**: éŸ³å£°å†ç”Ÿä¸­ã¯statusã‚’"speaking"ã«ç¶­æŒ

---

## ä¸¦åˆ—TTSå‡¦ç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PARALLEL TTS ARCHITECTURE                         â”‚
â”‚                    (TEN Framework Inspired)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  LLM Streaming                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ "[EMOTION:excited]ã‚¢ãƒ‹ãƒ¡æ˜ ç”»ã§ã™ã­ï¼ãŠã™ã™ã‚ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚      â”‚ â”‚
â”‚  â”‚  1. åƒã¨åƒå°‹ã®ç¥éš ã—ã€‚å®®å´é§¿ç›£ç£ã®åä½œã§ã™ã€‚                    â”‚ â”‚
â”‚  â”‚  2. ã‚‚ã®ã®ã‘å§«ã€‚å£®å¤§ãªç‰©èªã§ã™ã€‚"                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚      â”‚                                                                â”‚
â”‚      â–¼ Sentence Detection (ã€‚ï¼ï¼Ÿã§åˆ†å‰²)                             â”‚
â”‚      â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚       â”‚           â”‚           â”‚           â”‚                       â”‚
â”‚  â–¼       â–¼           â–¼           â–¼           â–¼                       â”‚
â”‚ Sent.0  Sent.1      Sent.2      Sent.3      Sent.4                   â”‚
â”‚ "ã‚¢ãƒ‹   "ãŠã™ã™     "1.åƒã¨     "å®®å´é§¿     "2.ã‚‚ã®                  â”‚
â”‚  ãƒ¡..."  ã‚..."      åƒå°‹..."    ç›£ç£..."    ã®ã‘..."                â”‚
â”‚  â”‚       â”‚           â”‚           â”‚           â”‚                       â”‚
â”‚  â–¼       â–¼           â–¼           â–¼           â–¼                       â”‚
â”‚ TTS     TTS         TTS         TTS         TTS                      â”‚
â”‚ #0      #1          #2          #3          #4                       â”‚
â”‚  â”‚       â”‚           â”‚           â”‚           â”‚                       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                       â”‚
â”‚  â”‚  â”‚                                        â”‚                       â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
â”‚  â”‚  â”‚  â”‚  MAX_CONCURRENT_TTS = 3             â”‚                       â”‚
â”‚  â”‚  â”‚  â”‚  (Rate limit protection)            â”‚                       â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚  â”‚  â”‚                                                                â”‚
â”‚  â–¼  â–¼                                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚  withTTSLimit() Queue                                          â”‚  â”‚
â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”              â”‚  â”‚
â”‚ â”‚  â”‚ TTS0 â”‚ â”‚ TTS1 â”‚ â”‚ TTS2 â”‚    â”‚ TTS3 â”‚ â”‚ TTS4 â”‚ (waiting)    â”‚  â”‚
â”‚ â”‚  â”‚ Run  â”‚ â”‚ Run  â”‚ â”‚ Run  â”‚    â”‚ Wait â”‚ â”‚ Wait â”‚              â”‚  â”‚
â”‚ â”‚  â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚
â”‚ â”‚     â”‚        â”‚        â”‚                                        â”‚  â”‚
â”‚ â”‚     â–¼        â–¼        â–¼                                        â”‚  â”‚
â”‚ â”‚  audio_chunk sent immediately as each completes                â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Frontend Audio Queue Processing:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  audioQueueRef: Map<index, audioData>                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ index: 0 â†’ "base64..." (received first, plays first)           â”‚â”‚
â”‚  â”‚ index: 1 â†’ "base64..." (may arrive before 0 finishes)          â”‚â”‚
â”‚  â”‚ index: 2 â†’ "base64..."                                          â”‚â”‚
â”‚  â”‚ ...                                                              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                       â”‚
â”‚  processNextChunk():                                                  â”‚
â”‚    if (currentIndex === 0 && chunk[0] exists) â†’ play                 â”‚
â”‚    onended â†’ currentIndex++ â†’ play next                              â”‚
â”‚    if (currentIndex >= total) â†’ playback complete                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Lottieã‚¢ãƒã‚¿ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LOTTIE AVATAR SYSTEM                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  Status-based Animation Mapping                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚   Status        â†’  Lottie File        â†’  Color                  â”‚ â”‚
â”‚  â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚  â”‚   idle          â†’  /character/idle.lottie      â†’  #94a3b8      â”‚ â”‚
â”‚  â”‚   listening     â†’  /character/listen.lottie    â†’  #34d399 ğŸŸ¢   â”‚ â”‚
â”‚  â”‚   thinking      â†’  /character/thinking.lottie  â†’  #22d3ee ğŸ”µ   â”‚ â”‚
â”‚  â”‚   speaking      â†’  /character/talk.lottie      â†’  #60a5fa ğŸ”·   â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                       â”‚
â”‚  Frontend Status Override Logic (page.tsx)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚   const status = useMemo(() => {                                â”‚ â”‚
â”‚  â”‚     if (audioPlayer.isPlaying) {                                â”‚ â”‚
â”‚  â”‚       return "speaking";  // Override backend status            â”‚ â”‚
â”‚  â”‚     }                                                           â”‚ â”‚
â”‚  â”‚     return wsStatus;      // Use backend status                 â”‚ â”‚
â”‚  â”‚   }, [audioPlayer.isPlaying, wsStatus]);                        â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚   Problem: Backend sends "idle" before audio finishes playing   â”‚ â”‚
â”‚  â”‚   Solution: Frontend maintains "speaking" during playback       â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                       â”‚
â”‚  Animation Flow                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚   User sends message                                            â”‚ â”‚
â”‚  â”‚         â”‚                                                       â”‚ â”‚
â”‚  â”‚         â–¼                                                       â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚ â”‚
â”‚  â”‚   â”‚ idle.lottie â”‚ â†’ status: "idle"                              â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                               â”‚ â”‚
â”‚  â”‚          â”‚  Backend: status = "thinking"                        â”‚ â”‚
â”‚  â”‚          â–¼                                                       â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚ â”‚
â”‚  â”‚   â”‚ thinking.lottie  â”‚ â†’ status: "thinking"                     â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚ â”‚
â”‚  â”‚            â”‚  Audio chunk arrives, audioPlayer.isPlaying = true â”‚ â”‚
â”‚  â”‚            â–¼                                                     â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚ â”‚
â”‚  â”‚   â”‚ talk.lottie â”‚ â†’ status: "speaking" (frontend override)      â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                               â”‚ â”‚
â”‚  â”‚          â”‚  Audio playback completes                            â”‚ â”‚
â”‚  â”‚          â–¼                                                       â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚ â”‚
â”‚  â”‚   â”‚ idle.lottie â”‚ â†’ status: "idle"                              â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                       â”‚
â”‚  Available Lottie Files:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  /public/character/                                              â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ idle.lottie      (default state)                           â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ listen.lottie    (listening for input)                     â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ thinking.lottie  (processing)                              â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ talk.lottie      (speaking/audio playing)                  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ happy.lottie     (emotion)                                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ excited.lottie   (emotion)                                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ confused.lottie  (emotion)                                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ surprised.lottie (emotion)                                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ cry.lottie       (emotion)                                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ scared.lottie    (emotion)                                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ cheer.lottie     (emotion)                                 â”‚ â”‚
â”‚  â”‚  â””â”€â”€ wave.lottie      (greeting)                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ„Ÿæƒ…ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        EMOTION FLOW                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  User Input                                                           â”‚
â”‚      â”‚                                                                â”‚
â”‚      â–¼                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Claude Analysis                                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚  Input: "ãŠã™ã™ã‚ã®ã‚¢ãƒ‹ãƒ¡æ˜ ç”»ã‚’æ•™ãˆã¦"                    â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  â†“                                                       â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  Sentiment: Positive, Curious                            â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  â†“                                                       â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  Selected Emotion: excited (ãƒ¯ã‚¯ãƒ¯ã‚¯)                    â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  â†“                                                       â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  Output: [EMOTION:excited] + Response text               â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚      â”‚                                                                â”‚
â”‚      â–¼                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Emotion â†’ TTS Style Mapping                                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ Emotion       â”‚ Azure TTS Style â”‚ Style Degree            â”‚  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚ â”‚
â”‚  â”‚  â”‚ happy         â”‚ cheerful        â”‚ 1.2                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ excited       â”‚ cheerful        â”‚ 1.8 (ã‚ˆã‚Šå¼·èª¿)          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ sad           â”‚ sad             â”‚ 1.0                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ thinking      â”‚ calm            â”‚ 0.8                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ neutral       â”‚ default         â”‚ 1.0                     â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ˜ ç”»æ¤œç´¢Tool Useãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MOVIE SEARCH TOOL USE FLOW                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  1. User Query                                                        â”‚
â”‚     "å®®å´é§¿ã®æ˜ ç”»ã‚’æ•™ãˆã¦"                                            â”‚
â”‚         â”‚                                                             â”‚
â”‚         â–¼                                                             â”‚
â”‚  2. Prefetch Detection (needsMovieSearch)                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚     â”‚ Keywords: æ˜ ç”», å‹•ç”», ã‚¢ãƒ‹ãƒ¡, ãŠã™ã™ã‚, ç›£ç£, ä¿³å„ª...          â”‚â”‚
â”‚     â”‚ â†’ Match found â†’ Start prefetch in parallel                    â”‚â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚         â”‚                                                             â”‚
â”‚         â–¼                                                             â”‚
â”‚  3. Claude Initial Response (streaming)                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚     â”‚ {                                                              â”‚â”‚
â”‚     â”‚   "stop_reason": "tool_use",                                   â”‚â”‚
â”‚     â”‚   "content": [{                                                â”‚â”‚
â”‚     â”‚     "type": "tool_use",                                        â”‚â”‚
â”‚     â”‚     "name": "search_movies",                                   â”‚â”‚
â”‚     â”‚     "input": { "query": "å®®å´é§¿" }                             â”‚â”‚
â”‚     â”‚   }]                                                           â”‚â”‚
â”‚     â”‚ }                                                              â”‚â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚         â”‚                                                             â”‚
â”‚         â–¼                                                             â”‚
â”‚  4. Use Prefetched Results (if available)                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚     â”‚ if (prefetchPromise && query matches) {                        â”‚â”‚
â”‚     â”‚   return await prefetchPromise;  // Skip duplicate query      â”‚â”‚
â”‚     â”‚ }                                                              â”‚â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚         â”‚                                                             â”‚
â”‚         â–¼                                                             â”‚
â”‚  5. Claude Final Response (with tool_result)                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚     â”‚ "[EMOTION:excited]                                             â”‚â”‚
â”‚     â”‚  å®®å´é§¿ç›£ç£ã®æ˜ ç”»ã§ã™ã­ï¼ç´ æ™´ã‚‰ã—ã„ä½œå“ãŒãŸãã•ã‚“ã‚ã‚Šã¾ã™ï¼    â”‚â”‚
â”‚     â”‚  1. åƒã¨åƒå°‹ã®ç¥éš ã— (2001) - è©•ä¾¡: 8.6..."                   â”‚â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼

| Type | èª¬æ˜ | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ |
|------|------|-----------|
| `text_input` | ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ | `text: string` |
| `start_listening` | éŸ³å£°å…¥åŠ›é–‹å§‹ | - |
| `stop_listening` | éŸ³å£°å…¥åŠ›åœæ­¢ | - |
| `ping` | æ¥ç¶šç¶­æŒ | - |

### ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

| Type | èª¬æ˜ | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ |
|------|------|-----------|
| `connected` | æ¥ç¶šæˆåŠŸ | `sessionId: string`, `message: string` |
| `status` | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–° | `status: string`, `emotion: string`, `statusText: string` |
| `user_message` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¢ºèª | `text: string` |
| `assistant_message` | ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå¿œç­”ï¼ˆæœ€çµ‚ï¼‰ | `text: string`, `emotion: string`, `messageId?: string` |
| `assistant_delta` | ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå¿œç­”ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰ | `text: string`, `messageId: string` |
| `audio` | éŸ³å£°ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ•ãƒ«ãƒãƒƒã‚¯ï¼‰ | `data: string (base64)`, `format: string` |
| `audio_chunk` | éŸ³å£°ãƒãƒ£ãƒ³ã‚¯ï¼ˆä¸¦åˆ—TTSï¼‰ | `data: string`, `format: string`, `index: number`, `total: number`, `isLast: boolean` |
| `waiting` | Waitingä¿¡å·ï¼ˆDBæ¤œç´¢å‰ï¼‰ | `index: number`, `text: string` |
| `workflow_timing` | ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | `steps: array`, `hasDbSearch: boolean`, `dbSearchTime: number`, `usedTool: boolean`, `totalMs: number` |
| `error` | ã‚¨ãƒ©ãƒ¼ | `message: string` |
| `tts_error` | TTS ã‚¨ãƒ©ãƒ¼ | `message: string` |
| `pong` | Pingå¿œç­” | - |

---

## Configuration

```typescript
// Backend Configuration (handler.ts)
const ENABLE_PARALLEL_TTS = true;           // Enable parallel TTS processing
const MIN_SENTENCE_LENGTH_FOR_TTS = 5;      // Minimum chars to trigger TTS
const MAX_CONCURRENT_TTS = 3;               // Concurrent TTS limit (rate limiting)
const SHORT_RESPONSE_THRESHOLD = 30;        // Skip chunking for short responses

// Frontend Configuration
const WS_URL = process.env.NEXT_PUBLIC_WS_URL || "ws://localhost:3001/ws";

// Waiting Phrase Configuration (.env.local)
const NEXT_PUBLIC_WAITING_THRESHOLD = 1000;     // Time (ms) before playing waiting phrase
const NEXT_PUBLIC_POST_WAITING_DELAY = 500;     // Delay (ms) after waiting phrase completes
```

---

## Waiting Phrases (DBæ¤œç´¢å‰ã®å¾…æ©Ÿãƒ•ãƒ¬ãƒ¼ã‚º)

Tool Useæ¤œå‡ºæ™‚ã«ã€DBæ¤œç´¢ã®å‰ã«å†ç”Ÿã•ã‚Œã‚‹å¾…æ©Ÿãƒ•ãƒ¬ãƒ¼ã‚ºã€‚
Frontend ã¯ `public/waiting/{index}.mp3` ã‹ã‚‰ãƒ—ãƒªãƒ¬ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸéŸ³å£°ã‚’å†ç”Ÿã€‚

| Index | Phrase |
|-------|--------|
| 0 | ã‚‚ã¡ã‚ã‚“ã€‚æ€¥ã„ã§ç¢ºèªã™ã‚‹ã‹ã‚‰ã€å¾…ã£ã¦ã¦ã­ã€‚ |
| 1 | äº†è§£ã€‚ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã­ã€‚ |
| 2 | ã†ã‚“ã€ã‚ã‹ã£ãŸã€‚ä»Šç¢ºèªã™ã‚‹ã‹ã‚‰å¾…ã£ã¦ã¦ã­ã€‚ |
| 3 | ãªã‚‹ã»ã©ã€‚å°‘ã—èª¿ã¹ã¦ã¿ã‚‹ã‹ã‚‰å¾…ã£ã¦ã¦ã€‚ |
| 4 | OKã€‚å†…å®¹ã‚’ç¢ºèªã™ã‚‹ã‹ã‚‰ã€å°‘ã€…ãŠå¾…ã¡ã‚’ã€‚ |
| 5 | ä»»ã›ã¦ã€‚ä¸å¯§ã«ãŠèª¿ã¹ã™ã‚‹ã‹ã‚‰ã€å°‘ã—å¾…ã£ã¦ã¦ã­ã€‚ |
| 6 | æ‰¿çŸ¥ã—ãŸã‚ˆã€‚ã¡ã‚‡ã£ã¨è€ƒãˆã‚‹ã‹ã‚‰å¾…ã£ã¦ã¦ãã‚Œã‚‹ï¼Ÿ |
| 7 | ã‚ã€ãã®ã“ã¨ã ã­ã€‚ä»Šèª¿ã¹ã¦ã‚ã’ã‚‹ã‹ã‚‰å¾…ã£ã¦ã€‚ |
| 8 | ç¢ºã‹ã«ã€‚ã™ãç¢ºèªã™ã‚‹ã‹ã‚‰ã€ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã¦ã€‚ |
| 9 | ã„ã„ã‚ˆã€‚èª¿ã¹ã¦ã¿ã‚‹ã‹ã‚‰ã€ãã“ã§å¾…ã£ã¦ã¦ã­ã€‚ |
| 10 | ã†ã‚“ã€ã‚ã‹ã‚‹ã‚ˆã€‚ã™ãã«èª¿ã¹ã¦ã¿ã‚‹ã­ã€‚ |
| 11 | ãŠã£ã‘ãƒ¼ã€‚æƒ…å ±ã‚’æ¢ã—ã¦ãã‚‹ã‹ã‚‰ã€å¾…ã£ã¦ã¦ã­ã€‚ |
| 12 | äº†è§£äº†è§£ã€‚è½ã¡ç€ã„ã¦èª¿ã¹ã‚‹ã‹ã‚‰ã€å¾…ã£ã¦ã¦ã­ã€‚ |
| 13 | ãã†ã ã­ã€‚ã™ãç¢ºèªã™ã‚‹ã‹ã‚‰ã€ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã€‚ |
| 14 | ãŠå®‰ã„å¾¡ç”¨ã ã‚ˆã€‚ä»Šã™ãèª¿ã¹ã‚‹ã‹ã‚‰å¾…ã£ã¦ã¦ã­ã€‚ |
| 15 | ã‚ªãƒƒã‚±ãƒ¼ã€‚ã—ã£ã‹ã‚Šæ¢ã—ã¦ã¿ã‚‹ã‹ã‚‰ã€å¾…ã£ã¦ã¦ã€‚ |
| 16 | ãã†ã ã‚ˆã­ã€‚ä»Šã€è©³ã—ãç¢ºèªã™ã‚‹ã‹ã‚‰ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã€‚ |
| 17 | ãŠã£ã‘ãƒ¼ã€‚ã™ãæº–å‚™ã™ã‚‹ã‹ã‚‰ã€ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã¦ã­ã€‚ |
| 18 | æ•™ãˆã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ä»Šã™ãèª¿ã¹ã‚‹ã‹ã‚‰å¾…ã£ã¦ã¦ã€‚ |
| 19 | äº†è§£ã—ãŸã‚ˆã€‚ã™ãã«è¦‹ã¤ã‘ã¦ãã‚‹ã‹ã‚‰ã€å¾…ã£ã¦ã¦ã­ã€‚ |

### Audio Files Setup

```
frontend/public/waiting/
â”œâ”€â”€ 0.mp3   # "ã‚‚ã¡ã‚ã‚“ã€‚æ€¥ã„ã§ç¢ºèªã™ã‚‹ã‹ã‚‰ã€å¾…ã£ã¦ã¦ã­ã€‚"
â”œâ”€â”€ 1.mp3   # "äº†è§£ã€‚ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã­ã€‚"
â”œâ”€â”€ 2.mp3   # "ã†ã‚“ã€ã‚ã‹ã£ãŸã€‚ä»Šç¢ºèªã™ã‚‹ã‹ã‚‰å¾…ã£ã¦ã¦ã­ã€‚"
â”œâ”€â”€ ...
â””â”€â”€ 19.mp3  # "äº†è§£ã—ãŸã‚ˆã€‚ã™ãã«è¦‹ã¤ã‘ã¦ãã‚‹ã‹ã‚‰ã€å¾…ã£ã¦ã¦ã­ã€‚"
```

ã“ã‚Œã‚‰ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã¯ Azure TTS ã¾ãŸã¯ä»–ã®TTSã‚µãƒ¼ãƒ“ã‚¹ã§äº‹å‰ã«ç”Ÿæˆã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
